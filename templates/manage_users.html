{% extends 'dashboard_layout.html' %}

{% block title %}Kelola Pengguna{% endblock %}

{% block dashboard_content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold mb-0">Kelola Pengguna</h1>
            <p class="text-muted mb-0">Daftar semua pengguna yang tercatat dalam sistem blockchain.</p>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Email Pengguna</th>
                            <th scope="col">Peran</th>
                            <th scope="col">Waktu Registrasi (UTC)</th>
                            <th scope="col" class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if users %}
                            {% for user in users %}
                            <tr>
                                <th scope="row">{{ loop.index }}</th>
                                <td>{{ user.email }}</td>
                                <td>
                                    {% if user.role == 'admin' %}
                                        <span class="badge bg-danger">Admin</span>
                                    {% elif user.role == 'dosen' %}
                                        <span class="badge bg-info text-dark">Dosen</span>
                                    {% elif user.role == 'mahasiswa' %}
                                        <span class="badge bg-success">Mahasiswa</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ user.role }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ user.timestamp | strftime('%Y-%m-%d %H:%M:%S') }}</td>
                                <td class="text-center">
                                    <!-- Tombol Edit Diaktifkan -->
                                    <button type="button" class="btn btn-sm btn-outline-warning" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editUserModal" 
                                            data-user-email="{{ user.email }}" 
                                            data-user-role="{{ user.role }}">
                                        Edit
                                    </button>
                                    {% if user.email != session.email %}
                                    <a href="{{ url_for('delete_user', email=user.email) }}" 
                                        class="btn btn-sm btn-outline-danger" 
                                        onclick="return confirm('Anda yakin ingin menonaktifkan pengguna ini? Aksi ini tidak dapat dibatalkan.')">
                                        Hapus
                                        </a>
                                        {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        {% else %}
                            <tr>
                                <td colspan="5" class="text-center text-muted py-4">Belum ada pengguna yang terdaftar.</td>
                            </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

<!-- Modal Baru untuk Edit Pengguna -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editUserModalLabel">Edit Peran Pengguna</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="{{ url_for('edit_user') }}">
          <div class="modal-body">
            <input type="hidden" name="user_email" id="editUserEmail">
            <p>Anda akan mengubah peran untuk: <strong id="emailToEdit"></strong></p>
            <div class="mb-3">
                <label for="editUserRole" class="form-label">Peran Baru</label>
                <select class="form-select" id="editUserRole" name="new_role" required>
                    <option value="admin">Admin</option>
                    <option value="dosen">Dosen</option>
                    <option value="mahasiswa">Mahasiswa</option>
                </select>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
            <button type="submit" class="btn btn-primary">Simpan Perubahan</button>
          </div>
      </form>
    </div>
  </div>
</div>

<!-- Script untuk Modal Edit -->
<script>
    const editUserModal = document.getElementById('editUserModal');
    if (editUserModal) {
        editUserModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const userEmail = button.getAttribute('data-user-email');
            const userRole = button.getAttribute('data-user-role');
            
            const modalEmailDisplay = editUserModal.querySelector('#emailToEdit');
            const userEmailInput = editUserModal.querySelector('#editUserEmail');
            const userRoleSelect = editUserModal.querySelector('#editUserRole');

            modalEmailDisplay.textContent = userEmail;
            userEmailInput.value = userEmail;
            userRoleSelect.value = userRole;
        });
    }
</script>
{% endblock %}
